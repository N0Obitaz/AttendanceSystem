@page
@model AttendanceSystem.Pages.ScanQR.ScanQRModel
@{
    ViewData["Title"] = "Scan QR & Log Location";
}

<h2>@ViewData["Title"]</h2>

<!-- QR Scanner Form -->
<form method="post" enctype="multipart/form-data">
    <input type="file" asp-for="InputFile" />
    <button type="submit" asp-page-handler="Scan">Scan QR</button>
</form>

<hr />

<h3>QR Output</h3>
<p>Email: @Model.OutputEmail</p>
<p>Last Name: @Model.LastName</p>
<p>Student Number: @Model.StudentNumber</p>

<hr />

<!-- Button to Log Location -->
<button id="btnLocation">Log My Location</button>
<p id="locationResult"></p>

@section Scripts {
    <script>
        document.getElementById("btnLocation").addEventListener("click", async () => {
            if (!navigator.geolocation) {
                alert("Geolocation not supported by this browser.");
                return;
            }

            navigator.geolocation.getCurrentPosition(async (pos) => {
                const data = {
                    latitude: pos.coords.latitude,
                    longitude: pos.coords.longitude,
                    accuracy: pos.coords.accuracy
                };

                const response = await fetch("?handler=LogLocation", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                document.getElementById("locationResult").innerText = result.message;
            }, (err) => {
                alert("Error getting location: " + err.message);
            });
        });
    </script>
}
